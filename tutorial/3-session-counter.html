<html><head><title>Gavial: Cross-Tier Counter</title><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="be.tzbob" /><meta name="description" content="Multi-tier Functional Reactive Programming" /><meta name="og:image" content="/gavial/img/poster.png" /><meta name="image" property="og:image" content="/gavial/img/poster.png" /><meta name="og:title" content="Gavial: Cross-Tier Counter" /><meta name="title" property="og:title" content="Gavial: Cross-Tier Counter" /><meta name="og:site_name" content="Gavial" /><meta name="og:url" content="" /><meta name="og:type" content="website" /><meta name="og:description" content="Multi-tier Functional Reactive Programming" /><link rel="icon" type="image/png" href="/gavial/img/favicon.png" /><meta name="twitter:title" content="Gavial: Cross-Tier Counter" /><meta name="twitter:image" content="/gavial/img/poster.png" /><meta name="twitter:description" content="Multi-tier Functional Reactive Programming" /><meta name="twitter:card" content="summary_large_image" /><link rel="icon" type="image/png" sizes="16x16" href="/gavial/img/favicon16x16.png" /><link rel="icon" type="image/png" sizes="24x24" href="/gavial/img/favicon24x24.png" /><link rel="icon" type="image/png" sizes="32x32" href="/gavial/img/favicon32x32.png" /><link rel="icon" type="image/png" sizes="48x48" href="/gavial/img/favicon48x48.png" /><link rel="icon" type="image/png" sizes="57x57" href="/gavial/img/favicon57x57.png" /><link rel="icon" type="image/png" sizes="60x60" href="/gavial/img/favicon60x60.png" /><link rel="icon" type="image/png" sizes="64x64" href="/gavial/img/favicon64x64.png" /><link rel="icon" type="image/png" sizes="70x70" href="/gavial/img/favicon70x70.png" /><link rel="icon" type="image/png" sizes="72x72" href="/gavial/img/favicon72x72.png" /><link rel="icon" type="image/png" sizes="76x76" href="/gavial/img/favicon76x76.png" /><link rel="icon" type="image/png" sizes="96x96" href="/gavial/img/favicon96x96.png" /><link rel="icon" type="image/png" sizes="114x114" href="/gavial/img/favicon114x114.png" /><link rel="icon" type="image/png" sizes="120x120" href="/gavial/img/favicon120x120.png" /><link rel="icon" type="image/png" sizes="128x128" href="/gavial/img/favicon128x128.png" /><link rel="icon" type="image/png" sizes="144x144" href="/gavial/img/favicon144x144.png" /><link rel="icon" type="image/png" sizes="150x150" href="/gavial/img/favicon150x150.png" /><link rel="icon" type="image/png" sizes="152x152" href="/gavial/img/favicon152x152.png" /><link rel="icon" type="image/png" sizes="196x196" href="/gavial/img/favicon196x196.png" /><link rel="icon" type="image/png" sizes="310x310" href="/gavial/img/favicon310x310.png" /><link rel="icon" type="image/png" sizes="310x150" href="/gavial/img/favicon310x150.png" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" /><link rel="stylesheet" href="/gavial/highlight/styles/atom-one-light.css" /><link rel="stylesheet" href="/gavial/css/style.css" /><link rel="stylesheet" href="/gavial/css/palette.css" /><link rel="stylesheet" href="/gavial/css/codemirror.css" /></head><body class="docs"><div id="wrapper"><div id="sidebar-wrapper"><ul id="sidebar" class="sidebar-nav"><li class="sidebar-brand"><a href="/gavial/" class="brand"><div class="brand-wrapper"><span>Gavial</span></div></a></li><li><a href="/gavial/tutorial/1-introduction.html" class="">Introduction</a></li><li><a href="/gavial/tutorial/2-client-counter.html" class="">Client Counter</a></li><li><a href="/gavial/tutorial/3-session-counter.html" class=" active ">Cross-Tier Counter</a></li><li><a href="/gavial/tutorial/4-frp-taxonomy.html" class="">FRP Primitives</a></li><li><a href="/gavial/" class=""></a></li><li><a href="/gavial/css/palette.css" class=""></a></li><li><a href="/gavial/css/style.css" class=""></a></li></ul></div><div id="page-content-wrapper"><div class="nav"><div class="container-fluid"><div class="row"><div class="col-lg-12"><div class="action-menu pull-left clearfix"><a href="#menu-toggle" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a></div><ul class="pull-right"><li id="gh-eyes-item" class="hidden-xs"><a href="https://github.com/tzbob/gavial"><i class="fa fa-eye"></i><span>WATCH<span id="eyes" class="label label-default">--</span></span></a></li><li id="gh-stars-item" class="hidden-xs"><a href="https://github.com/tzbob/gavial"><i class="fa fa-star-o"></i><span>STARS<span id="stars" class="label label-default">--</span></span></a></li><li><a href="#" onclick="shareSiteTwitter('Gavial Multi-tier Functional Reactive Programming');"><i class="fa fa-twitter"></i></a></li><li><a href="#" onclick="shareSiteFacebook('Gavial Multi-tier Functional Reactive Programming');"><i class="fa fa-facebook"></i></a></li><li><a href="#" onclick="shareSiteGoogle();"><i class="fa fa-google-plus"></i></a></li></ul></div></div></div></div><div id="content" data-github-owner="tzbob" data-github-repo="gavial"><div class="content-wrapper"><section><h1 id="creating-server-counters">Creating Server Counters</h1>

<p>Next we extend the client counter example to compute on the server, we will have to variants: a private and a shared counter.</p>

<p><strong>Objectives</strong></p>

<ul>
  <li>Learn the concept of <em>Tiers</em>, more specifically the <code class="highlighter-rouge">Client</code>, <code class="highlighter-rouge">Session</code> and <code class="highlighter-rouge">App</code> tiers</li>
  <li>Communicate between tiers using replication primitives such as <code class="highlighter-rouge">.toSession</code></li>
</ul>

<h2 id="tiers">Tiers</h2>

<p align="center"><img src="../imgs/tiers.svg" style="width=100%;max-width:640px" /></p>

<p>Gavial programs are written in a three-tier-system.
The <em>client</em> tier corresponds to all code that is run in the browser on the client and for one application there are conceptually multiple clients alive all running the client-tier code.
The server consists of two tiers, a <em>session</em> tier and an <em>application</em> tier.
A session tier is the client tier’s server counterpart and for each conceptual instance of the client tier there is a corresponding session instance. The session tier is used to execute client-specific code on the server. The application tier on the other hand is shared, there is only one instance of the application tier.</p>

<p>In Gavial FRP primitives are expressed in the form of <code class="highlighter-rouge">TierPrimitive</code>, e.g., <code class="highlighter-rouge">ClientEvent</code> or <code class="highlighter-rouge">Tier#Primitive</code>, e.g., <code class="highlighter-rouge">SessionTier#DBehavior</code>.</p>

<h2 id="creating-a-private-server-counter">Creating a Private (server) Counter</h2>

<p>We start from the client counter example and re-define <code class="highlighter-rouge">state</code> to be executed on the server:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="n">sessionState</span> <span class="k">=</span> <span class="nc">ClientEvent</span><span class="o">.</span><span class="n">toSession</span><span class="o">(</span><span class="n">counterSource</span><span class="o">).</span><span class="n">fold</span><span class="o">(</span><span class="mi">0</span><span class="o">)(</span><span class="k">_</span> <span class="o">+</span> <span class="k">_</span><span class="o">)</span>
<span class="c1">// sessionState: SessionTier#DBehavior[Int] = mtfrp.core.SessionDBehavior@65eabb74
</span><span class="k">val</span> <span class="n">state</span> <span class="k">=</span> <span class="nc">SessionDBehavior</span><span class="o">.</span><span class="n">toClient</span><span class="o">(</span><span class="n">sessionState</span><span class="o">)</span>
<span class="c1">// state: ClientDBehavior[Int] = mtfrp.core.ClientDBehavior@5110b41
</span></code></pre></div></div>

<p>We use two replication primitives (<code class="highlighter-rouge">.toSession</code> and <code class="highlighter-rouge">.toClient</code>) to convert between tiers.
First the counter events are brought to the server on the <em>session</em> tier after which they are folded in the same way as before.
The new <code class="highlighter-rouge">sessionState</code> contains the counter state on the server for each specific client separately and is just as easily replicated to the client with the <code class="highlighter-rouge">.toClient</code> primitive completing the new server-side definition of <code class="highlighter-rouge">state</code>. All other code (<code class="highlighter-rouge">ui</code>, etc.) remains unchanged.</p>

<p>Note that</p>

<h2 id="creating-a-shared-counter">Creating a Shared Counter</h2>

<p>To create a shared counter we once again redefine how the counter is folded. The behavior of this example should be that several clients at once share the same counter and see the same state. Whenever a client adds to subtracts from the counter, all other clients immediately see the changes.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="n">appState</span> <span class="k">=</span> <span class="nc">SessionEvent</span><span class="o">.</span><span class="n">toApp</span><span class="o">(</span><span class="nc">ClientEvent</span><span class="o">.</span><span class="n">toSession</span><span class="o">(</span><span class="n">counterSource</span><span class="o">)).</span><span class="n">fold</span><span class="o">(</span><span class="mi">0</span><span class="o">)(</span><span class="k">_</span> <span class="o">+</span> <span class="k">_</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">sum</span><span class="o">)</span>
<span class="c1">// appState: AppTier#DBehavior[Int] = mtfrp.core.AppDBehavior@5919b6be
</span><span class="k">val</span> <span class="n">state</span> <span class="k">=</span> <span class="nc">SessionDBehavior</span><span class="o">.</span><span class="n">toClient</span><span class="o">(</span><span class="nc">AppDBehavior</span><span class="o">.</span><span class="n">toSession</span><span class="o">(</span><span class="n">appState</span><span class="o">))</span>
<span class="c1">// state: ClientDBehavior[Int] = mtfrp.core.ClientDBehavior@66fdf6b4
</span></code></pre></div></div>

<p>This time we define <code class="highlighter-rouge">appState</code>, state computed on the <code class="highlighter-rouge">App</code> tier by going from client to session to application.
Note that going from the session tier to the application tier involves multiplicity, that is, <code class="highlighter-rouge">SessionEvent.toApp</code> in this case does not return an event of integers but a <code class="highlighter-rouge">AppEvent[Map[Client, Int]]</code> where <code class="highlighter-rouge">Client</code> corresponds to a client connection.
We define <code class="highlighter-rouge">appState</code> by ignoring all keys and simply summing all values.
The final <code class="highlighter-rouge">state</code> definition is similar to before and the application state is replicated to the client tier across the session tier.
Multiplicity here has broadcast semantics by default — all updates are sent to all clients.</p>

<p>The final result shown below is an implementation of a websocket-backed counter that automatically propagates changes (through the application tier) to all connected clients.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">mtfrp.core._</span>
<span class="k">import</span> <span class="nn">UI.html.all._</span>

<span class="k">object</span> <span class="nc">HelloApp</span> <span class="k">extends</span> <span class="nc">GavialApp</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">port</span> <span class="k">=</span> <span class="mi">8080</span>
  <span class="k">val</span> <span class="n">host</span> <span class="k">=</span> <span class="s">"localhost"</span>

  <span class="k">val</span> <span class="n">headExtensions</span> <span class="k">=</span> <span class="nc">List</span><span class="o">(</span><span class="n">script</span><span class="o">(</span><span class="n">src</span> <span class="o">:=</span> <span class="n">s</span><span class="s">"hello-fastopt-bundle.js"</span><span class="o">))</span>

  <span class="k">val</span> <span class="n">counterSource</span> <span class="k">=</span> <span class="nc">ClientEvent</span><span class="o">.</span><span class="n">source</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span>

  <span class="k">val</span> <span class="n">appState</span> <span class="k">=</span> <span class="nc">SessionEvent</span><span class="o">.</span><span class="n">toApp</span><span class="o">(</span><span class="nc">ClientEvent</span><span class="o">.</span><span class="n">toSession</span><span class="o">(</span><span class="n">counterSource</span><span class="o">)).</span><span class="n">fold</span><span class="o">(</span><span class="mi">0</span><span class="o">)(</span><span class="k">_</span> <span class="o">+</span> <span class="k">_</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">sum</span><span class="o">)</span>
  <span class="k">val</span> <span class="n">state</span> <span class="k">=</span> <span class="nc">SessionDBehavior</span><span class="o">.</span><span class="n">toClient</span><span class="o">(</span><span class="nc">AppDBehavior</span><span class="o">.</span><span class="n">toSession</span><span class="o">(</span><span class="n">appState</span><span class="o">))</span>


  <span class="k">val</span> <span class="n">ui</span> <span class="k">=</span> <span class="n">state</span><span class="o">.</span><span class="n">map</span> <span class="o">{</span> <span class="n">c</span> <span class="k">=&gt;</span>
    <span class="n">div</span><span class="o">(</span><span class="n">h1</span><span class="o">(</span><span class="s">"Count!"</span><span class="o">),</span>
        <span class="n">button</span><span class="o">(</span><span class="s">"+"</span><span class="o">,</span> <span class="nc">UI</span><span class="o">.</span><span class="n">listen</span><span class="o">(</span><span class="n">onclick</span><span class="o">,</span> <span class="n">counterSource</span><span class="o">)(</span><span class="k">_</span> <span class="k">=&gt;</span> <span class="mi">1</span><span class="o">)),</span>
        <span class="n">button</span><span class="o">(</span><span class="s">"-"</span><span class="o">,</span> <span class="nc">UI</span><span class="o">.</span><span class="n">listen</span><span class="o">(</span><span class="n">onclick</span><span class="o">,</span> <span class="n">counterSource</span><span class="o">)(</span><span class="k">_</span> <span class="k">=&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="o">)),</span>
        <span class="n">p</span><span class="o">(</span><span class="n">c</span><span class="o">)</span>
    <span class="o">)</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

</section></div></div></div></div><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script><script src="/gavial/highlight/highlight.pack.js"></script><script>hljs.configure({languages:['scala','java','bash']});
hljs.initHighlighting();
              </script><script src="/gavial/js/main.js"></script></body></html>